<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JazzFlix Video Upload with Progress</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .upload-section {
            margin-bottom: 30px;
        }
        .progress-section {
            margin-top: 20px;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 30px;
            background-color: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 15px;
        }
        .status-info {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .status-uploading { background-color: #e3f2fd; color: #1976d2; }
        .status-processing { background-color: #fff3e0; color: #f57c00; }
        .status-thumbnail { background-color: #f3e5f5; color: #7b1fa2; }
        .status-completed { background-color: #e8f5e8; color: #2e7d32; }
        .status-failed { background-color: #ffebee; color: #c62828; }
        .file-input {
            margin: 10px 0;
            padding: 10px;
            border: 2px dashed #ccc;
            border-radius: 5px;
            width: 100%;
            text-align: center;
            cursor: pointer;
        }
        .btn {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .result.success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .result.error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .thumbnail {
            max-width: 200px;
            max-height: 150px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
    </style>
    <script defer src="/jazz/js/jazzflix-upload.js"></script>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¬ JazzFlix Video Upload</h1>

        <div class="upload-section">
            <h2>Upload Video</h2>
            <input type="file" id="videoFile" accept="video/*" class="file-input">
            <br>
            <button id="uploadBtn" class="btn">Start Upload</button>
        </div>

        <div class="progress-section" id="progressSection">
            <h2>Upload Progress</h2>
            <div class="status-info" id="statusInfo">Initializing...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressText">0%</div>
        </div>

        <div class="result" id="result">
            <h3 id="resultTitle"></h3>
            <p id="resultMessage"></p>
            <img id="thumbnailImg" class="thumbnail" alt="Video thumbnail">
        </div>

        <!-- DASH Video Player -->
        <div class="video-player" id="videoPlayerSection" style="display: none; margin-top: 30px;">
            <h2>MPEG-DASH Video Player</h2>
            <video id="videoPlayer" controls style="width: 100%; max-width: 800px;"></video>
            <br>
            <button id="loadDashBtn" class="btn" style="margin-top: 10px;">Load DASH Stream</button>
        </div>
    </div>

    <script>
        let eventSource = null;
        let currentUploadId = null;
        let currentVideoId = null;
        let dashPlayer = null;

        // Upload file
        document.getElementById('uploadBtn').addEventListener('click', async function() {
            const fileInput = document.getElementById('videoFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a video file first!');
                return;
            }

            // Show progress section
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('result').style.display = 'none';
            document.getElementById('uploadBtn').disabled = true;

            // Create form data
            const formData = new FormData();
            formData.append('file', file);

            try {
                // Start upload
                const response = await fetch('/jazz/video/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    currentUploadId = data.data.uploadId;
                    console.log('Upload started with ID:', currentUploadId);

                    // Connect to SSE for progress updates
                    connectSSE();

                } else {
                    showError('Upload failed', data.message);
                }

            } catch (error) {
                console.error('Upload error:', error);
                showError('Upload failed', error.message);
            }
        });

        // Connect to Server-Sent Events
        function connectSSE() {
            if (eventSource) {
                eventSource.close();
            }

            eventSource = new EventSource(`/jazz/progress/sse/${currentUploadId}`);

            eventSource.onmessage = function(event) {
                const progress = JSON.parse(event.data);
                updateProgress(progress);
            };

            eventSource.onerror = function(error) {
                console.log('SSE connection error:', error);
                // Fallback to polling
                pollProgress();
            };
        }

        // Poll for progress updates (fallback)
        function pollProgress() {
            if (!currentUploadId) return;

            const pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/jazz/video/api/progress/${currentUploadId}`);
                    if (response.ok) {
                        const progress = await response.json();
                        updateProgress(progress);

                        // Stop polling if completed or failed
                        if (progress.status === 'COMPLETED' || progress.status === 'FAILED') {
                            clearInterval(pollInterval);
                            if (eventSource) eventSource.close();
                        }
                    }
                } catch (error) {
                    console.log('Progress polling error:', error);
                }
            }, 2000); // Poll every 2 seconds
        }

        // Update progress display
        function updateProgress(progress) {
            console.log('Progress update:', progress);

            // Update progress bar
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            progressFill.style.width = progress.progressPercentage + '%';
            progressText.textContent = progress.progressPercentage + '%';

            // Update status
            const statusInfo = document.getElementById('statusInfo');
            statusInfo.textContent = progress.message;
            statusInfo.className = 'status-info status-' + progress.status.toLowerCase();

            // Handle completion
            if (progress.status === 'COMPLETED') {
                document.getElementById('uploadBtn').disabled = false;
                showSuccess(progress);

                // Show thumbnail if available
                if (progress.videoId) {
                    document.getElementById('thumbnailImg').src = `/jazz/video/api/thumbnail/${progress.videoId}`;
                    document.getElementById('thumbnailImg').style.display = 'block';
                }
            } else if (progress.status === 'FAILED') {
                document.getElementById('uploadBtn').disabled = false;
                showError('Upload failed', progress.message);
            }
        }

        // Show success result
        function showSuccess(progress) {
            const result = document.getElementById('result');
            const title = document.getElementById('resultTitle');
            const message = document.getElementById('resultMessage');

            result.className = 'result success';
            result.style.display = 'block';
            title.textContent = 'âœ… Upload Completed!';
            message.textContent = `Video "${progress.fileName}" has been uploaded and transcoded to DASH format. Video ID: ${progress.videoId}`;

            // Show video player section
            document.getElementById('videoPlayerSection').style.display = 'block';

            // Store video ID for DASH loading
            currentVideoId = progress.videoId;
        }

        // Show error result
        function showError(title, message) {
            const result = document.getElementById('result');
            const titleEl = document.getElementById('resultTitle');
            const messageEl = document.getElementById('resultMessage');

            result.className = 'result error';
            result.style.display = 'block';
            titleEl.textContent = 'âŒ ' + title;
            messageEl.textContent = message;
        }

        // Load DASH stream
        // document.getElementById('loadDashBtn').addEventListener('click', function() {
        //     if (!currentVideoId) {
        //         alert('No video available to play');
        //         return;
        //     }
        //
        //     const manifestUrl = `http://localhost:9080/videos-q360p/videos/${currentVideoId}/dash/manifest.mpd`;
        //     // const manifestUrl = `/jazz/video/api/dash/${currentVideoId}/manifest.mpd`;
        //
        //     // Initialize DASH player
        //     const videoElement = document.getElementById('videoPlayer');
        //     if (dashPlayer) {
        //         dashPlayer.reset();
        //     }
        //
        //     dashPlayer = dashjs.MediaPlayer().create();
        //     dashPlayer.initialize(videoElement, manifestUrl, true);
        //
        //     dashPlayer.on(dashjs.MediaPlayer.events.STREAM_INITIALIZED, function() {
        //         console.log('DASH stream initialized');
        //     });
        //
        //     dashPlayer.on(dashjs.MediaPlayer.events.ERROR, function(e) {
        //         console.error('DASH player error:', e);
        //         alert('Error loading DASH stream: ' + e.error.message);
        //     });
        // });

        //Load DASH Stream Updated
        document.getElementById('loadDashBtn').addEventListener('click', function () {
            if (!currentVideoId) {
                alert('No video available');
                return;
            }

            const quality = "q360p"; // later make this dynamic

            const manifestUrl =
                `http://localhost:9080/videos-${quality}/videos/${currentVideoId}/dash/manifest.mpd`;

            const videoElement = document.getElementById('videoPlayer');

            if (dashPlayer) {
                dashPlayer.reset();
            }

            dashPlayer = dashjs.MediaPlayer().create();
            dashPlayer.initialize(videoElement, manifestUrl, true);

            dashPlayer.on(dashjs.MediaPlayer.events.STREAM_INITIALIZED, () => {
                console.log("DASH stream initialized");
            });

            dashPlayer.on(dashjs.MediaPlayer.events.ERROR, (e) => {
                console.error("DASH error", e);
                alert("Failed to load DASH stream");
            });
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('JazzFlix Video Upload initialized');
        });
    </script>

    <!-- DASH.js for MPEG-DASH playback -->
    <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>